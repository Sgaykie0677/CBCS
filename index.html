<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBCS Interactive Study Guide</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for professional look and better readability */
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .module-card { transition: all 0.3s ease; }
        .module-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .quiz-option:hover { background-color: #f0f4ff; cursor: pointer; }
        .correct { background-color: #d1fae5; border-color: #10b981; }
        .incorrect { background-color: #fee2e2; border-color: #ef4444; }
        .fade-in { animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="p-4 sm:p-8">
    <script>
        // --- FIREBASE SETUP (Mandatory for dynamic/interactive apps) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = null;

        // Initialize Firebase and Authentication
        const initFirebase = async () => {
            try {
                if (firebaseConfig) {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);

                    // Sign in using the provided token or anonymously
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }

                    // Set up Auth State Listener
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            console.log("Firebase initialized. User ID:", userId);
                            document.getElementById('user-id-display').textContent = `User ID: ${userId.substring(0, 8)}... (for sharing)`;
                        } else {
                            // If sign-in fails or user logs out, assign a random ID (less secure but keeps app working)
                            userId = crypto.randomUUID();
                            console.log("Signed out or failed sign-in. Using temporary ID.");
                            document.getElementById('user-id-display').textContent = `Session ID: ${userId.substring(0, 8)}...`;
                        }
                    });
                } else {
                    console.error("Firebase configuration not available.");
                }
            } catch (error) {
                console.error("Error during Firebase initialization:", error);
            }
        };

        if (firebaseConfig) initFirebase();
        // --- END FIREBASE SETUP ---

        // --- GEMINI API INTEGRATION ---
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent";
        const API_KEY = ""; // Canvas will provide this if empty

        const practiceSchema = {
            type: "ARRAY",
            items: {
                type: "OBJECT",
                properties: {
                    question: { type: "STRING", description: "The multiple-choice question text." },
                    options: { type: "ARRAY", items: { type: "STRING" }, description: "Array of exactly 4 answer options." },
                    correctAnswer: { type: "STRING", description: "The text of the correct answer, which must match one of the options." },
                    topic: { type: "STRING", description: "The topic covered (e.g., ICD-10, Anatomy, RCM)." }
                },
                required: ["question", "options", "correctAnswer", "topic"]
            }
        };

        let currentQuiz = [];
        let currentQuestionIndex = 0;
        let score = 0;

        async function generatePracticeQuestions(topic = "Certified Billing and Coding Specialist Exam") {
            const quizContainer = document.getElementById('quiz-container');
            const statusElement = document.getElementById('quiz-status');
            const retryButton = document.getElementById('retry-quiz-btn');

            quizContainer.innerHTML = '';
            statusElement.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Generating 5 practice questions on ${topic}...`;
            retryButton.classList.add('hidden');

            const userQuery = `Generate 5 challenging multiple-choice questions for a Certified Billing and Coding Specialist (CBCS) exam preparation, covering the core areas: Medical Terminology, Anatomy & Physiology, ICD-10-CM Coding, CPT/HCPCS Coding, and Revenue Cycle Management (RCM) or Compliance. Ensure each question has exactly four distinct options and a clearly identified correct answer.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: {
                    parts: [{ text: "You are an expert CBCS exam proctor. Your task is to generate five high-quality, exam-level multiple-choice questions in JSON format." }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: practiceSchema
                }
            };

            try {
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const result = await response.json();
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (jsonText) {
                    currentQuiz = JSON.parse(jsonText);
                    currentQuestionIndex = 0;
                    score = 0;
                    renderQuestion();
                } else {
                    statusElement.textContent = "Error: Could not parse questions from the model. Please retry.";
                    retryButton.classList.remove('hidden');
                }
            } catch (error) {
                console.error("API call error:", error);
                statusElement.textContent = `Failed to load questions. Error: ${error.message}`;
                retryButton.classList.remove('hidden');
            }
        }

        function renderQuestion() {
            const quizContainer = document.getElementById('quiz-container');
            const statusElement = document.getElementById('quiz-status');
            const q = currentQuiz[currentQuestionIndex];

            if (!q) {
                statusElement.textContent = `Quiz Complete! You scored ${score} out of ${currentQuiz.length}.`;
                document.getElementById('retry-quiz-btn').classList.remove('hidden');
                quizContainer.innerHTML = '';
                return;
            }

            statusElement.innerHTML = `<span class="font-semibold text-indigo-600">Question ${currentQuestionIndex + 1} of ${currentQuiz.length}</span> | Topic: ${q.topic}`;

            let optionsHtml = q.options.map((option, index) => `
                <div class="quiz-option p-4 my-2 border border-gray-200 rounded-lg shadow-sm bg-white hover:border-indigo-400"
                     data-answer="${option}" onclick="checkAnswer(this, '${q.correctAnswer.replace(/'/g, "\\'")}')">
                    <span class="font-medium text-gray-700">${String.fromCharCode(65 + index)}.</span> ${option}
                </div>
            `).join('');

            quizContainer.innerHTML = `
                <div class="fade-in">
                    <p class="text-xl font-bold mb-4 text-gray-800">${q.question}</p>
                    ${optionsHtml}
                    <div id="feedback-${currentQuestionIndex}" class="mt-4 text-lg font-semibold min-h-[1.5rem]"></div>
                    <button id="next-btn-${currentQuestionIndex}" onclick="nextQuestion()"
                            class="mt-6 w-full px-4 py-2 bg-indigo-500 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-600 transition duration-150 ease-in-out hidden">
                        Next Question &rarr;
                    </button>
                </div>
            `;
        }

        window.checkAnswer = (element, correctAnswer) => {
            const selectedAnswer = element.getAttribute('data-answer');
            const isCorrect = selectedAnswer === correctAnswer;
            const feedbackElement = document.getElementById(`feedback-${currentQuestionIndex}`);
            const options = document.querySelectorAll('.quiz-option');

            // Disable all options
            options.forEach(opt => {
                opt.onclick = null;
                if (opt.getAttribute('data-answer') === correctAnswer) {
                    opt.classList.add('correct');
                    opt.classList.remove('hover:border-indigo-400');
                } else {
                    opt.classList.remove('hover:border-indigo-400');
                }
                opt.classList.remove('bg-white');
            });

            if (isCorrect) {
                element.classList.add('correct');
                feedbackElement.innerHTML = '<span class="text-green-600">✅ Correct! Excellent job.</span>';
                score++;
            } else {
                element.classList.add('incorrect');
                feedbackElement.innerHTML = `<span class="text-red-600">❌ Incorrect. The correct answer was highlighted.</span>`;
            }

            // Show Next button
            document.getElementById(`next-btn-${currentQuestionIndex}`).classList.remove('hidden');
        };

        window.nextQuestion = () => {
            currentQuestionIndex++;
            renderQuestion();
        };

        // --- END GEMINI API INTEGRATION ---

        // --- MODULE 1: TERMINOLOGY BUILDER LOGIC ---
        function analyzeTerm() {
            const termInput = document.getElementById('term-input').value.toLowerCase().trim();
            const resultDiv = document.getElementById('term-analysis-result');
            resultDiv.innerHTML = '';
            
            if (!termInput) {
                resultDiv.innerHTML = '<p class="text-red-500">Please enter a medical term to analyze.</p>';
                return;
            }

            // Simple rule-based analysis based on common parts from Chapter 1
            let analysis = {
                term: termInput,
                prefix: '',
                root: '',
                suffix: '',
                definition: 'Analysis is approximate. Always verify in a medical dictionary!'
            };

            // Basic Prefixes (Hyper-, Hypo-, Tachy-, Brady-, Epi-, Peri-)
            if (termInput.startsWith('hyper')) { analysis.prefix = 'Hyper- (excessive)'; analysis.root = termInput.substring(5); }
            else if (termInput.startsWith('hypo')) { analysis.prefix = 'Hypo- (deficient)'; analysis.root = termInput.substring(4); }
            else if (termInput.startsWith('tachy')) { analysis.prefix = 'Tachy- (fast)'; analysis.root = termInput.substring(5); }
            else if (termInput.startsWith('brady')) { analysis.prefix = 'Brady- (slow)'; analysis.root = termInput.substring(5); }
            else if (termInput.startsWith('epi')) { analysis.prefix = 'Epi- (upon/above)'; analysis.root = termInput.substring(3); }
            else if (termInput.startsWith('peri')) { analysis.prefix = 'Peri- (around)'; analysis.root = termInput.substring(4); }
            // Basic Suffixes (-itis, -ectomy, -algia, -otomy)
            if (analysis.root.endsWith('ectomy')) { analysis.suffix = '-ectomy (surgical removal)'; analysis.root = analysis.root.slice(0, -6); }
            else if (analysis.root.endsWith('itis')) { analysis.suffix = '-itis (inflammation)'; analysis.root = analysis.root.slice(0, -4); }
            else if (analysis.root.endsWith('algia')) { analysis.suffix = '-algia (pain)'; analysis.root = analysis.root.slice(0, -5); }
            else if (analysis.root.endsWith('otomy')) { analysis.suffix = '-otomy (surgical incision)'; analysis.root = analysis.root.slice(0, -5); }
            
            // Clean up root for combining vowels if a prefix wasn't found first
            if (!analysis.prefix && !analysis.suffix) {
                analysis.root = termInput;
            }

            resultDiv.innerHTML = `
                <div class="mt-4 p-4 border-2 border-indigo-200 rounded-xl bg-indigo-50">
                    <h4 class="font-bold text-lg text-indigo-700 mb-2">Analysis for: <span class="capitalize">${termInput}</span></h4>
                    <p><strong>Prefix:</strong> <span class="text-red-600">${analysis.prefix || 'N/A'}</span></p>
                    <p><strong>Root Word (Core):</strong> <span class="text-green-600">${analysis.root.replace(/[oiaeu]/, (v) => `(${v})`)}</span></p>
                    <p><strong>Suffix:</strong> <span class="text-blue-600">${analysis.suffix || 'N/A'}</span></p>
                    <p class="mt-2 text-sm italic">${analysis.definition}</p>
                </div>
            `;
        }

        // --- WINDOW LOAD & INITIALIZATION ---
        window.onload = () => {
            // Load initial quiz on page load
            generatePracticeQuestions("CBCS Core Topics");
        };

        // Expose functions globally for HTML event handlers
        window.generatePracticeQuestions = generatePracticeQuestions;
        window.analyzeTerm = analyzeTerm;
    </script>

    <!-- Header Section -->
    <header class="bg-indigo-600 text-white p-6 rounded-t-xl shadow-lg mb-8">
        <h1 class="text-3xl sm:text-4xl font-extrabold">CBCS Interactive Study Tool</h1>
        <p class="text-indigo-200 mt-1">Based on the Certified Billing & Coding Specialist Handbook Curriculum</p>
        <p id="user-id-display" class="text-xs text-indigo-300 mt-2">Initializing...</p>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- MODULE 1: Chapter 1 - Medical Terminology Review -->
        <div class="lg:col-span-1 module-card bg-white p-6 rounded-xl shadow-md border-t-4 border-indigo-500">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5s3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18s-3.332.477-4.5 1.253"></path></svg>
                1. Terminology Builder
            </h2>
            <p class="text-gray-600 mb-4">Practice deconstructing medical terms into their core components (Prefix, Root, Suffix) as per Chapter 1.</p>
            
            <input type="text" id="term-input" placeholder="e.g., Cholecystectomy or Tachycardia"
                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-3">
            
            <button onclick="analyzeTerm()"
                    class="w-full p-3 bg-indigo-500 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-600 transition duration-150">
                Analyze Term
            </button>
            
            <div id="term-analysis-result" class="mt-4">
                <!-- Analysis results appear here -->
            </div>
        </div>

        <!-- MODULE 2: Coding & Billing Practice Quiz -->
        <div class="lg:col-span-2 module-card bg-white p-6 rounded-xl shadow-md border-t-4 border-teal-500">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-teal-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                2. CBCS Exam Practice Generator
            </h2>
            <p class="text-gray-600 mb-4">Use the Gemini AI to generate a quick, 5-question multiple-choice quiz covering all core CBCS topics (ICD-10, CPT, RCM, Compliance).</p>
            
            <div id="quiz-status" class="text-center p-3 mb-4 text-sm font-medium text-gray-700 flex items-center justify-center bg-gray-100 rounded-lg">
                Loading practice questions...
            </div>
            
            <div id="quiz-container" class="mb-6">
                <!-- Quiz questions will be rendered here -->
            </div>

            <button id="retry-quiz-btn" onclick="generatePracticeQuestions('CBCS Core Topics')"
                    class="w-full px-4 py-2 bg-teal-500 text-white font-semibold rounded-lg shadow-md hover:bg-teal-600 transition duration-150 ease-in-out hidden">
                Generate New Quiz
            </button>
        </div>

        <!-- MODULE 3: Revenue Cycle Management (RCM) Flow -->
        <div class="lg:col-span-3 module-card bg-white p-6 rounded-xl shadow-md border-t-4 border-yellow-500">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c1.657 0 3 .895 3 2s-1.343 2-3 2h-1v2H9V8h3z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 16h6M9 20h6M9 4h6"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 12V4a2 2 0 012-2h12a2 2 0 012 2v16a2 2 0 01-2 2H6a2 2 0 01-2-2v-8"></path></svg>
                3. Revenue Cycle Management (RCM) Overview
            </h2>
            <p class="text-gray-600 mb-4">Visualize the 8-step RCM process (Chapter 8/9 concepts) and the key role of the CBCS at each stage.</p>
            
            <!-- RCM Flow Visualization - Responsive Grid -->
            <div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-8 gap-4 text-center">
                
                <div class="bg-blue-100 p-3 rounded-lg border-2 border-blue-300">
                    <p class="font-bold text-blue-800">1. Pre-Registration</p>
                    <p class="text-xs text-blue-700">Verify Eligibility/Authorization</p>
                </div>
                <div class="flex items-center justify-center text-gray-500 font-bold hidden sm:block">&rarr;</div>
                
                <div class="bg-green-100 p-3 rounded-lg border-2 border-green-300">
                    <p class="font-bold text-green-800">2. Encounter</p>
                    <p class="text-xs text-green-700">Documentation (EHR)</p>
                </div>
                <div class="flex items-center justify-center text-gray-500 font-bold hidden sm:block">&rarr;</div>

                <div class="bg-purple-100 p-3 rounded-lg border-2 border-purple-300">
                    <p class="font-bold text-purple-800">3. Coding</p>
                    <p class="text-xs text-purple-700">ICD-10/CPT/HCPCS Assignment</p>
                </div>
                <div class="flex items-center justify-center text-gray-500 font-bold hidden sm:block">&rarr;</div>

                <div class="bg-orange-100 p-3 rounded-lg border-2 border-orange-300">
                    <p class="font-bold text-orange-800">4. Claim Submission</p>
                    <p class="text-xs text-orange-700">Scrubbing & Transmission (CMS-1500)</p>
                </div>
                <div class="flex items-center justify-center text-gray-500 font-bold sm:hidden block col-span-2 mt-2 mb-2">&darr;</div>

                <div class="bg-red-100 p-3 rounded-lg border-2 border-red-300">
                    <p class="font-bold text-red-800">5. Payer Adjudication</p>
                    <p class="text-xs text-red-700">Review, Payment, or Denial (EOB/ERA)</p>
                </div>
                <div class="flex items-center justify-center text-gray-500 font-bold hidden sm:block">&rarr;</div>

                <div class="bg-pink-100 p-3 rounded-lg border-2 border-pink-300">
                    <p class="font-bold text-pink-800">6. Denial Management</p>
                    <p class="text-xs text-pink-700">Analyze, Appeal, or Write-off</p>
                </div>
                <div class="flex items-center justify-center text-gray-500 font-bold hidden sm:block">&rarr;</div>
                
                <div class="bg-yellow-100 p-3 rounded-lg border-2 border-yellow-300">
                    <p class="font-bold text-yellow-800">7. Patient Billing</p>
                    <p class="text-xs text-yellow-700">Generate Statement (A/R)</p>
                </div>
                <div class="flex items-center justify-center text-gray-500 font-bold hidden sm:block">&rarr;</div>
                
                <div class="bg-gray-100 p-3 rounded-lg border-2 border-gray-300">
                    <p class="font-bold text-gray-800">8. Collections/Follow-up</p>
                    <p class="text-xs text-gray-700">Account Resolution & CE</p>
                </div>
            </div>
        </div>
    </main>

    <footer class="mt-8 p-4 text-center text-sm text-gray-500">
        <p>&copy; 2024 CBCS Study Tool | Interactive content generated by Gemini AI.</p>
    </footer>

</body>
</html>
